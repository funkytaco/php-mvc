---
- name: Generate self-signed SSL certificate (EDA triggered)
  hosts: localhost
  gather_facts: no
  
  vars:
    app_name: "<%APP_NAME%>"
    api_prefix: "<%API_PREFIX%>"
    order_update_endpoint: "<%ORDER_UPDATE_ENDPOINT%>"
    cert_path: "/tmp/ssl/{{ domain }}"
    
  tasks:
    - name: Ensure openssl is installed
      ansible.builtin.shell: |
        microdnf install -y openssl
      args:
        creates: /usr/bin/openssl
      ignore_errors: yes

    - name: Create certificate directory
      ansible.builtin.file:
        path: "{{ cert_path }}"
        state: directory
        mode: '0755'
        
    - name: Generate private key using openssl command
      ansible.builtin.command: >
        openssl genrsa -out {{ cert_path }}/privkey.pem 2048
      args:
        creates: "{{ cert_path }}/privkey.pem"
      register: private_key_result
      ignore_errors: yes
      
    - name: Generate self-signed certificate
      ansible.builtin.command: >
        openssl req -new -x509 -key {{ cert_path }}/privkey.pem
        -out {{ cert_path }}/fullchain.pem -days 365
        -subj "/C=US/ST=State/L=City/O=Organization/CN={{ domain }}"
      args:
        creates: "{{ cert_path }}/fullchain.pem"
      register: cert_result
      ignore_errors: yes
      when: private_key_result is succeeded
      
    - name: Debug output on success
      debug:
        msg: "Self-signed certificate generated successfully for {{ domain }}"
      when: cert_result is succeeded
      
    - name: Post failure to order endpoint
      ansible.builtin.uri:
        url: "http://{{ app_name }}-app:8080{{ order_update_endpoint }}/{{ order_id }}"
        method: POST
        body_format: json
        body:
          status: "ORDER_FAILED"
          error_message: "Self-signed certificate generation failed"
        headers:
          Content-Type: "application/json"
        status_code: [200, 201]
      when: cert_result is failed
      ignore_errors: yes
      
    - name: Post success to order endpoint
      ansible.builtin.uri:
        url: "http://{{ app_name }}-app:8080{{ order_update_endpoint }}/{{ order_id }}"
        method: POST
        body_format: json
        body:
          status: "ORDER_COMPLETED"
          certificate_path: "{{ cert_path }}/fullchain.pem"
        headers:
          Content-Type: "application/json"
        status_code: [200, 201]
      when: cert_result is succeeded
      ignore_errors: yes